### Развёртывание современного веб-сервера под старые проекты на PHP 5.2.17

### Предыдущие этапы:

* 1. [Установка системы Debian (или аналога) и первичные настройки](first-install-and-adjust-debian.md).
* 2. [Настройка SSH и окружения клиента](ssh-tuning.md).
* 3. [Установка и настройка MySQL](install-and-adjust-MySQL-fоr-php-5.2.17.md).

# 4: Сборка и настройка допотопного PHP 5.2.17 вместе с FPM.

Для составления последовательности команд для сборки древней PHP 5.2.17 автору понадобился перерыть много страниц мирового интернета и совершить несчётное число ошибок. Данный рецепт гарантированно сработает для [Debian 8.6 (Jessie) x64](https://cdimage.debian.org/cdimage/archive/8.6.0/amd64/). На момент сборки PHP в систему уже был установлен MySQL Server. Коннектор к базе входит в ядро PHP и поэтому при сборке PHP нужно как минимум знать расположение UNIX-сокетов для связи с MySQL. Расположение этих сокетов сборщик получит из конфигурационных файлов MySQL. Настоятельно советуем [сделать установку MySQL перед компиляцией PHP](install-and-adjust-MySQL-fоr-php-5.2.17.md).

К сожалению, автор не смог проверить применимость рецепта для всех вариантов [Debian 8.x «Jessie»](https://www.debian.org/releases/jessie/debian-installer/), в частности не получилось собрать PHP 5.2.17 для 32-битной версии Debian 8.10 «Jessie» i368. Предположительно для неё не недостаёт соответствующего `libjpeg-dev` пакета (`libjpeg` для разработчиков). Для Debian 9 «Stretch» не хватало ещё большего числа библиотек. Если у вас есть эмпирически-подверженные рекомендации по сборке необходимого состава библиотек для этих и других систем, присылайте коммиты или свяжитесь с автором.

С высокой вероятностью данная инструкция, с небольшими поправками на состав библиотек, сработает и для других версий PHP и систем линейки Debian (например, Ubuntu и её клоны, Raspbian, Noobs и т.д.).

## Подготовка системы для компиляции PHP 5.2.17 и FPM

Для сборки  5.2.17 и FPM из исходников в системы должны быть установлены разработческие версии некоторых пакетов, Си-компилятор и сборщик. Автор долго мучился со сборкой, перебрал кучу dev-пакетов чтобы получить вариант PHP 5.2.17 с поддержкой всех необходимых ему модулей (включая `-ldap` и `ldap-sasl`). Наверняка часть пакетов избыточно (с учётом того, что многие из них тянут зависимости и по факту пакетов было установлено чуть более 200 пакетов). Если вы хотите улучшить ваш сервер и избежать загрузки лишних пакетов, то вам предстоит самому выяснить, что предлагаемого ниже установлено напрасно:

```bash
sudo apt-get install libxml2-dev \
                     libmysqlclient-dev \
                     libcurl4-gnutls-dev \
                     libpng12-dev \
                     libjpeg62-turbo-dev \
                     libjpeg-dev \
                     libxslt1-dev \
                     libbz2-dev \
                     libmcrypt-dev \
                     libmhash-dev \
                     libfcgi-dev \
                     libmhash-dev \
                     libssl-dev \
                     libcrypto++-dev \
                     lib32z1-dev \
                     libltdl-dev \
                     build-essential \
                     libcurl4-openssl-dev \
                     libexpat1-dev \
                     libsasl2-dev \
                     python-dev \
                     libldap2-dev \
                     libssl-dev \
                     libpcre3-dev \
                     gcc \
                     make checkinstall
```

Проверяем, что находимся в корне нашей домашней директории и получаем архив с исходниками допотопной PHP 5.2.17 из музея php.net:

```bash
cd ~
wget http://museum.php.net/php5/php-5.2.17.tar.gz
```

Распаковываем архив:

```bash
tar zxf ./php-5.2.17.tar.gz
```

Скачиваем патчи-заплатки безопасности для php-5.2.17 под Debian Jessie:

```bash
wget https://github.com/TommyLau/docker-lnmpa/raw/master/php/5.2/php-5.2.17-libxml2.patch
wget https://github.com/TommyLau/docker-lnmpa/raw/master/php/5.2/php-5.2.17-openssl.patch
```

Далее необходимо получить FPM - FastCGI Process Manager («Менеджер процессов FastCGI»). Это альтернативная реализация режима FastCGI в PHP с некоторыми дополнительными возможностями, которые, обычно, используются в высоконагруженных системах. В современных реализациях, модуль FPM входит в состав ядра PHP. Но на момент существования 5.2.17, FPM существовал всего лишь в качестве набора патчей от Андрея Нигматулина, которые устраняли ряд проблем, мешающих полноценно использовать PHP в режиме FastCGI.

PHP-FPM используется в основном в связке с nginx, и для Apache его присутствие не требуется (со всеми вытекающими последствиями деградации производительности FastCGI при нагрузках). Получаем исходники FPM:

```bash
wget "http://php-fpm.org/downloads/php-5.2.17-fpm-0.5.14.diff.gz" -O php-fpm.diff.gz
```

Переходим в папку в которую распаковался PHP:

```bash
cd ./php-5.2.17
```

И применяем полученные патчи:

```bash
patch -Np1 -i ../php-5.2.17-libxml2.patch
patch -Np1 -i ../php-5.2.17-openssl.patch
```

Распаковываем и применяем патчи PHP-FPM:

```bash
zcat ../php-fpm.diff.gz | patch -Np1
```

Казалось бы, всё готово для компиляции и сборки. Но увы, за долгие годы с тех пор когда PHP 5.2.17 был актуален, многие системные папки и папки системных библиотек поменяли свои дислокации. Нам придётся сделать несколько подмен с помощью сим-линков. Подмены происходят в системных папках, так что на потребуется права администратора. Для систем `x64` подмены следующие:

```bash
sudo ln -s /usr/lib/x86_64-linux-gnu/libjpeg.so.62.0.0 /usr/lib/libjpeg.so
sudo ln -s /lib/x86_64-linux-gnu/libpng12.so.0.50.0 /usr/lib/libpng.so
sudo ln -s /usr/lib/x86_64-linux-gnu/libmysqlclient.so.18.0.0 /usr/lib/libmysqlclient.so
```

для 32-битных систем x386 - такие подмены:

```bash
sudo ln -s /usr/lib/i386-linux-gnu/libjpeg.so.62.0.0 /usr/lib/libjpeg.so
sudo ln -s /lib/i386-linux-gnu/libpng12.so.0.50.0 /usr/lib/libpng.so
sudo ln -s /usr/lib/i368-linux-gnu/libmysqlclient.so.18.0.0 /usr/lib/libmysqlclient.so
```

Осталось сделать ещё одну, небольшую, замену подключаемых (для инструкций #include .h-файлов) папок в исходниках:

```bash
sed -i 's/freetype2\/freetype/freetype/' configure
```

## Сборка PHP 5.2.17 и FPM

Теперь всё подготовлено для сборки PHP и FPM. Можно собирать и установить, в отдельную папочку - это полезно, если предполагается использовать несколько версий PHP и оперативно переключаться между ними (для этого нам понадобится изменить значения ключей `--prefix` и `--with-config-file-path`, указав в них путь к требуемой папке). Но в нашем случае произведём установку в системную папку (понадобятся права администратора):

```bash
./configure \
      --prefix=/usr/local \
      --with-config-file-path=/usr/local/etc \
      --with-mcrypt \
      --with-gettext \
      --with-gd \
      --with-png-dir \
      --with-ttf \
      --with-curl \
      --enable-gd-native-ttf \
      --enable-mbstring \
      --enable-sockets \
      --with-png-dir \
      --with-pdo-mysql \
      --with-zlib \
      --enable-fastcgi \
      --enable-fpm \
      --enable-force-cgi-redirect \
      --with-mysql=/usr/local/mysql \
      --with-mysqli=/usr/bin/mysql_config \
      --with-ldap \
      --with-ldap-sasl \
      --with-jpeg-dir \
      --with-libdir=/lib/x86_64-linux-gnu
 ```

Начнётся сборка-компиляция. В процессе её, из-за отсутствия тех или иных библиотек или модулей разработчика, могут возникать ошибки. При возникновении ошибок выдаётся диагностика, с её помощью можно понять каких модулей не хватает - до устанавливать их и пробовать компиляцию повторно. Неплохую (хотя и устаревшую) инструкцию по разрешению ошибок компиляции моно найти [по ссылке](http://denik.od.ua/rasprostranennye_oshibki_pri_kompilirovanii_php). Скорее всего вы не найдёте рекомендованных этой инструкцией библиотек в репозиториях ваших систем, но как минимум она поможет определиться с направлением «куда копать» для поиска рецептов по разрешению конфликтов сборки.

#### *Примечание 1:*
*Поддержка LDAP в PHP не доступна по умолчанию. Для активации нужно использовать опцию `--with-ldap[=DIR]` при компиляции PHP, где DIR - это каталог установки библиотек доступа к базам LDAP. Для включения поддержки SASL, убедитесь что использована опция `--with-ldap-sasl[=DIR]` , и что sasl.h существует в системе. (см. [источник](http://php.net/manual/ru/ldap.installation.php))*

Успешное окончание сборки завершится сообщением о создании и размещении конфигурационных файлов и благодарностью:

```
Generating files
updating cache ./config.cache
creating ./config.status
creating php5.spec
creating main/build-defs.h
creating scripts/phpize
creating scripts/man1/phpize.1
creating scripts/php-config
creating scripts/man1/php-config.1
creating sapi/cli/php.1
creating sapi/cgi/fpm/fpm_autoconf.h
creating sapi/cgi/fpm/php-fpm.conf
creating sapi/cgi/fpm/php-fpm
creating main/php_config.h
creating main/internal_functions.c
creating main/internal_functions_cli.c
+--------------------------------------------------------------------+
| License:                                                           |
| This software is subject to the PHP License, available in this     |
| distribution in the file LICENSE.  By continuing this installation |
| process, you are bound by the terms of this license agreement.     |
| If you do not agree with the terms of this license, you must abort |
| the installation process at this point.                            |
+--------------------------------------------------------------------+

Thank you for using PHP.
```

На данном этапе всё готово для получения исполняемых файлов и установки PHP в систему. Если вы считаете себя гуру, то можете посмотреть и поправить созданные файлы с предлагаемыми настройками для компиляции. Например, если у вас всё ещё не установлен MySQL указать расположение MySQL-сокета.

Теперь рекомендуется получить и установить ещё одну заплатку-патч. Она проверит несколько строк кода на совместимость и, если нужно, внесёт необходимые изменения:

```bash
wget https://mail.gnome.org/archives/xml/2012-August/txtbgxGXAvz4N.txt
patch -p0 -b < txtbgxGXAvz4N.txt
```

Теперь можно сделать сборку и установить PHP 5.2.17 в систему (понадобятся системные права):

```bash
make
sudo make install
```

Т.к. при компиляции было указано, что установку надо произвести в системную папку, то никаких дополнительных настроек (как то, дать права на исполнение программ в папке PHP `chmod ugo+rX -R /opt/php5.2.17/` и добавление её к переменным пути `PATH=$PATH:/opt/php5.2/bin/') не потребуется. Можем запустить PHP и убедиться, что версия именно та, что требовалось (5.2.17):

```bash
php -v
```

В ответ получим:

```
PHP 5.2.17 (cli) (built: Dec  7 2017 11:58:07)
Copyright (c) 1997-2010 The PHP Group
Zend Engine v2.2.0, Copyright (c) 1998-2010 Zend Technologies
```

## Настройка FPM и связка с веб-сервером

Конфигурационный файл FPM находится в системной папке `/usr/local/etc/` и для его редактирования нужны системные права. По-хорошему надо перенести его в папку с config-файлами нашего сайта, но во времена PHP 5.2.17 была другая концепция управления конфигурациями, когда настройки всех PHP-сайтов и -проектов находятся в одном файле. Кроме того, изменился сам формат файла конфигурации. Раньше (то есть в нашем случае, ведь мы используем древний PHP) - конфигурационный файл FPM был в XML-формате, а современные версии используют стандартный формат `.ini` с представлением `переменная = значение`.

К счастью, у нас будет всего один сайт (он же сайт по умолчанию) и такое хранение файла конфигураций в системной папке никаких неудобств не создаст. Открывает фал на редактирование:

```bash
sudo nano /usr/local/etc/php-fpm.conf
```

Далее находим и меняем в нём настройки `error_log` - размещение log-файлов FPM (не забываем менять значения для **[user]** и **[site]** в путях к файлам):

```xml
    <value name="error_log">/home/[user]/[site]/logs/php-fpm.log</value>
```

Для `listen_address` указываем расположение сокета для обмена с данными с веб-сервером nginx (можно использовать веб-сокет из конфига по умолчанию - `127.0.0.1:9000` - но unix-сокет производительней). Снова, не забываем менять значения для **[user]** и **[site]** указывая пути к файлам:

```xml
    <value name="listen_address">/home/[user]/[site]/socket/php-fpm.socket</value>
    <!--    <value name="listen_address">127.0.0.1:9000</value>     -->
```

Далее нужно изменить значение `owner`, `group` и `mode` блока `listen_options`, указывающих разрешения на чтение и запись для сокета. Веб-сервер nginx работает от имени «***www-data***» (более рание версии) или «***nginx***» (более современные версии) и создаёт одноимённую группу для своих процессов - соответствующие значения нужно указать для атрибутов **owner** и **group** конфигурационного файла FPM/ Например, следующие значения:

```xml
    <value name="owner">nginx</value>
    <value name="group">nginx</value>
    <value name="mode">0660</value>
```

Далее, чуть ниже, можно сделать аналогичные изменяя для `user` и `group` внешнего блока `pool`. Они указывают от чьего имени будет запускаться процесс FPM для конкретного сайта. Чтобы php-скрипты могли производить запись на диск (например, upload или создание картинок) надо установить имя нашего пользователя **{user]**:

```xml
        <value name="user">[user]</value>
        <value name="group">[user]</value>
```

Если мы хотим ограничить FPM в числе ядер, то можно сделать это изменив параметр `rlimit_core`:

```xml
<value name="rlimit_core">1</value>
```

Всё. Настройки закончены. Сохраняем файл `Ctrl+O` и `Enter`, а затем выходим из редактора `Ctrl+X`.

К сожалению, более подробно о настройках старого FPM для PHP 5.2.17 сейчас уже не найти. Даже эти, предложенные выше, настройки были получены эмпирически, через сопоставление настроек современных FPM и предложенного по умолчанию `php-fpm.conf`.

Теперь можно запустить FPM. Т.к. для PHP 5.2.17 он ещё не был сервисом, запустить и остановить его с помощью стандартных команд `service` не получится. Запускается FPM так (необходимы права администратора):

```bash
sudo /usr/local/sbin/php-fpm start -y /usr/local/etc/php-fpm.conf
```

FPM запущен и можно убедится в том, что права доступа к сокету установлены верно:

```bash
ls -la /home/[user]/[site]/socket/php-fpm.socket
```

Права доступа должны быть «*srw-rw---*», владелец «***www-data***», группа «***www-data***». Например:

```
srw-rw---- 1 nginx nginx 0 янв  9 10:22 /home/[user]/[site]/socket/php-fpm.socket
```

Если права установлены неверно, или FPM не запустился, то следует проверить `php-fpm.conf` и попробовать запустить FPM снова. Перезапуск FPM осуществляется командой:

```bash
sudo /usr/local/sbin/php-fpm restart -y /usr/local/etc/php-fpm.conf
```

В некоторых случаях (скорее для перестраховки) следует перезагрузить и nginx:

```bash
sudo service nginx restart
```

## Автозапуск FPM при старте сервера

Для версии PHP 5.2.17 не существовало FastCGI Process Manager (FPM) в качестве сервиса. Его нужно стартовать отдельно. Чтобы происходил автоматический запуск FPM при каждой загрузке нашего сервера необходимо изменить системный файл `/etc/rc.local`. Открываем его на редактирование (нужны права администратора):

```bash
sudo nano /etc/rc.local
```

И перед самой последней строчкой `exit 0` вставляем в него команду запуска FPM. Должно получиться примерно так:

```bash
/usr/local/sbin/php-fpm start -y /usr/local/etc/php-fpm.conf
exit 0
```

Сохраняем файл `Ctrl+O` и `Enter`, выходим из редактора `Ctrl+X`. Теперь если перезагрузить наш сервер (потребуются права администратора) fpm будет запущен.


--------------

## Следующие этапы:

* 5. [Установка и настройка веб-сервера nginx](install-and-adjust-nginx-fоr-php-5.2.17.md).
* 6. [Настройка Joomla! 1.0.15](settings-config-for-Joolma-1.0.15.md) и настройка phpMyAdmin.
* 7. [Доустанавливаем поддержку LDAP](adding-ldap-to-debian-nginx-and-php.md) - доступ к Active Directory.
* 8. [Чистим систему от лишних модулей](claen.md).
* 9. [Резервный сайт, резервное копирование и восстановление сайта и синхронизация](backup-restore-and-syncronization-sites.md).